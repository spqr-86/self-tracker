```
╔══════════════════════════════════════════════════════════════════════════════╗
║  ██████╗  ██████╗  █████╗ ██████╗ ███╗   ███╗ █████╗ ██████╗                 ║
║  ██╔══██╗██╔═══██╗██╔══██╗██╔══██╗████╗ ████║██╔══██╗██╔══██╗                ║
║  ██████╔╝██║   ██║███████║██║  ██║██╔████╔██║███████║██████╔╝                ║
║  ██╔══██╗██║   ██║██╔══██║██║  ██║██║╚██╔╝██║██╔══██║██╔═══╝                 ║
║  ██║  ██║╚██████╔╝██║  ██║██████╔╝██║ ╚═╝ ██║██║  ██║██║                     ║
║  ╚═╝  ╚═╝ ╚═════╝ ╚═╝  ╚═╝╚═════╝ ╚═╝     ╚═╝╚═╝  ╚═╝╚═╝                     ║
╠══════════════════════════════════════════════════════════════════════════════╣
║  NEXUS OS v3.0 :: GAME SYSTEM REDESIGN                    [DEVELOPMENT PLAN] ║
║  Философия: Геймификация как инструмент рефлексии                            ║
╚══════════════════════════════════════════════════════════════════════════════╝
```

# План разработки игровой системы NEXUS OS v3.0

## Обзор фаз

```
┌─────────────────────────────────────────────────────────────────────────────┐
│  ФАЗА 0        ФАЗА 1        ФАЗА 2        ФАЗА 3        ФАЗА 4            │
│  Foundation    Core Loop     Perks 2.0     Intelligence  Polish            │
│                                                                             │
│  [████████]    [████████]    [████████]    [████████]    [████████]        │
│                                                                             │
│  Режимы        Священная     S.P.E.C.I.A.L Анти-перф.    Архив             │
│  Миграция      корова        Чеки          Сигналы       Графики           │
│  Структура     Недельный                   Детекторы     Экспорт           │
│                цикл                                                         │
│                                                                             │
│  ──────────────────────────────────────────────────────────────────────────│
│  Базовый       Минимальный   Полная        Защита        Долгосрочный      │
│  фундамент     рабочий       система       пользователя  прогресс          │
│                продукт       перков                                         │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## ФАЗА 0: Foundation (Фундамент)

**Цель:** Подготовить архитектуру без ломания текущего функционала.

### Задачи

```
┌─────────────────────────────────────────────────────────────────────┐
│  ФАЗА 0 :: FOUNDATION                                [PRIORITY: P0] │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  0.1 Структура данных                                               │
│  ────────────────────                                               │
│  □ Спроектировать новую схему localStorage                          │
│  □ Добавить версионирование данных (dataVersion: 3)                │
│  □ Написать миграцию: v2 → v3 (сохранить старые данные)            │
│                                                                     │
│  0.2 Система режимов                                                │
│  ───────────────────                                                │
│  □ Добавить поле currentMode: 'norm' | 'minimum' | 'crisis'        │
│  □ Добавить modeHistory: [{date, mode}]                            │
│  □ UI: Индикатор текущего режима в header                          │
│  □ UI: Модалка переключения режима                                  │
│                                                                     │
│  0.3 Рефакторинг storage.js                                         │
│  ──────────────────────────                                         │
│  □ Выделить GameStateManager (отдельный модуль)                    │
│  □ Методы: getMode(), setMode(), getModeHistory()                  │
│  □ Автосохранение при изменении режима                             │
│                                                                     │
│  КРИТЕРИЙ ГОТОВНОСТИ:                                               │
│  ✓ Режимы переключаются и сохраняются                              │
│  ✓ Старые данные не потеряны после миграции                        │
│  ✓ Индикатор режима виден на всех экранах                          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Новые файлы

```
js/
├── game-state.js      # GameStateManager (режимы, состояние)
├── migration.js       # Миграция данных v2 → v3
└── (существующие файлы остаются)
```

### Схема данных v3

```javascript
// localStorage: nexusGameState
{
  dataVersion: 3,
  currentMode: 'norm',           // 'norm' | 'minimum' | 'crisis'
  modeHistory: [
    { date: '2025-01-19', mode: 'norm' },
    { date: '2025-01-18', mode: 'minimum' }
  ],
  lastModeChange: '2025-01-19T10:30:00Z'
}
```

---

## ФАЗА 1: Core Loop (Ядро системы)

**Цель:** Священная корова + недельный цикл = минимальный рабочий продукт.

### Задачи

```
┌─────────────────────────────────────────────────────────────────────┐
│  ФАЗА 1 :: CORE LOOP                                 [PRIORITY: P0] │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1.1 Священная корова                                               │
│  ────────────────────                                               │
│  □ Структура данных: sacredCow в localStorage                      │
│  □ UI: Виджет на Dashboard (текущая неделя, streak)                │
│  □ UI: Кнопка "+1 попытка" с датой                                 │
│  □ Логика: streak обнуляется если <3 попыток за неделю             │
│  □ UI: История по неделям (последние 8)                            │
│                                                                     │
│  1.2 Недельный цикл                                                 │
│  ─────────────────                                                  │
│  □ Определение границ недели (Пн-Вс)                               │
│  □ Автоматический reset счётчика попыток в понедельник             │
│  □ UI: Индикатор "осталось дней до конца недели"                   │
│                                                                     │
│  1.3 Приветственный экран                                           │
│  ────────────────────────                                           │
│  □ При возвращении после 2+ дней: "С возвращением"                 │
│  □ Предложение выбрать режим (не guilt)                            │
│  □ Тон: нейтральный, поддерживающий                                │
│                                                                     │
│  КРИТЕРИЙ ГОТОВНОСТИ:                                               │
│  ✓ Можно отмечать попытки и видеть streak                          │
│  ✓ Streak корректно обнуляется/продолжается                        │
│  ✓ После пропуска — нейтральное приветствие                        │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Схема данных: Священная корова

```javascript
// localStorage: nexusSacredCow
{
  currentWeek: {
    weekStart: '2025-01-13',     // Понедельник
    attempts: 3,
    dates: ['2025-01-15', '2025-01-17', '2025-01-19']
  },
  streak: 4,                      // Недель подряд с 3+ попытками
  bestStreak: 8,
  history: [
    { weekStart: '2025-01-06', attempts: 5, success: true },
    { weekStart: '2024-12-30', attempts: 2, success: false }
  ]
}
```

### UI: Виджет священной коровы

```
┌─────────────────────────────────────────┐
│ ★ СВЯЩЕННАЯ КОРОВА                      │
├─────────────────────────────────────────┤
│                                         │
│  Эта неделя: ✓✓✓░░ (3/5)               │
│  Минимум выполнен ✓                     │
│                                         │
│  Streak: 4 недели                       │
│                                         │
│  [+ ПОПЫТКА]                            │
│                                         │
└─────────────────────────────────────────┘
```

---

## ФАЗА 2: Perks 2.0 (Система перков)

**Цель:** Новая система S.P.E.C.I.A.L. + еженедельные чеки.

### Задачи

```
┌─────────────────────────────────────────────────────────────────────┐
│  ФАЗА 2 :: PERKS 2.0                                 [PRIORITY: P1] │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  2.1 Еженедельный чек                                               │
│  ────────────────────                                               │
│  □ UI: Секция "Недельный чек" (новая)                              │
│  □ Форма: 3 поля (тело/дело/люди) + вопрос + корректировка         │
│  □ Напоминание: воскресенье вечером (опционально)                  │
│  □ История чеков (последние 12 недель)                             │
│                                                                     │
│  2.2 Новая система перков                                           │
│  ────────────────────────                                           │
│  □ 7 перков: STRENGTH, ENDURANCE, PERCEPTION,                      │
│    CHARISMA, INTELLIGENCE, AGILITY, LUCK                           │
│  □ Каждый перк: score (1-10), components, history                  │
│  □ UI: Экран перка (компоненты + динамика + что улучшить)          │
│  □ UI: Обзорный экран всех перков (radar chart или bars)           │
│                                                                     │
│  2.3 Обновление перков после чека                                   │
│  ────────────────────────────────                                   │
│  □ Автоподстановка фактов (попытки, режимы)                        │
│  □ Ручная корректировка субъективного                              │
│  □ Пересчёт score и сохранение в историю                           │
│                                                                     │
│  2.4 Миграция старых статов                                         │
│  ──────────────────────────                                         │
│  □ STR → STRENGTH (конвертация XP в начальный score)               │
│  □ PER → PERCEPTION                                                 │
│  □ INT → INTELLIGENCE                                               │
│  □ WIL → часть ENDURANCE + STRENGTH                                │
│  □ Старая система перков → заморозка (read-only)                   │
│                                                                     │
│  КРИТЕРИЙ ГОТОВНОСТИ:                                               │
│  ✓ Можно проходить недельный чек                                   │
│  ✓ Перки обновляются на основе чека                                │
│  ✓ Видна динамика перков за 4+ недели                              │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Схема данных: Перки v3

```javascript
// localStorage: nexusPerksV3
{
  lastUpdate: '2025-01-19',
  perks: {
    strength: {
      score: 6,
      components: {
        dailyStep: { value: 5, max: 7, weight: 3 },
        sacredCow: { value: 3, max: 5, weight: 3 },
        willpower: { value: 2, max: 4, weight: 4, subjective: true }
      },
      history: [
        { date: '2025-01-19', score: 6 },
        { date: '2025-01-12', score: 7 }
      ]
    },
    // ... остальные 6 перков
  }
}

// localStorage: nexusWeeklyChecks
{
  checks: [
    {
      date: '2025-01-19',
      weekStart: '2025-01-13',
      body: 'Бегал 3 раза, сон стабилен',
      work: '4 отклика, 1 тестовое',
      people: 'Созвон с другом',
      question: 'Прокрастинировал 2 дня',
      blocker: 'Сон сорвался',
      correction: 'Будильник сна в 22:30'
    }
  ]
}
```

### Формула расчёта перка

```javascript
// Пример для STRENGTH
function calculateStrength(data) {
  const { dailyStep, sacredCow, willpower } = data;

  // Базовые баллы (0-6)
  let score = 0;
  score += (dailyStep >= 5) ? 2 : (dailyStep >= 3) ? 1 : 0;  // +0-2
  score += (dailyStep === 7) ? 1 : 0;                         // +1 бонус
  score += (sacredCow >= 3) ? 2 : (sacredCow >= 1) ? 1 : 0;   // +0-2
  score += (sacredCow >= 5) ? 1 : 0;                          // +1 бонус

  // Субъективная оценка (0-4)
  score += willpower;  // 0-4

  return Math.min(10, score);  // Max 10
}
```

---

## ФАЗА 3: Intelligence (Умные механизмы)

**Цель:** Защита от перфекционизма + умные сигналы.

### Задачи

```
┌─────────────────────────────────────────────────────────────────────┐
│  ФАЗА 3 :: INTELLIGENCE                              [PRIORITY: P2] │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  3.1 Детектор самосуда                                              │
│  ─────────────────────                                              │
│  □ Паттерны: "я плохой", "я слабак", "я не могу", etc.             │
│  □ Анализ текста в недельном чеке                                  │
│  □ UI: Предупреждение с поддерживающим сообщением                  │
│  □ Кнопка "Пауза" → закрыть чек, вернуться позже                   │
│                                                                     │
│  3.2 Сигналы режимов                                                │
│  ───────────────────                                                │
│  □ Минимум >5 дней подряд → "Может, Норма слишком жёсткая?"        │
│  □ Кризис >3 дня → "Время сказать кому-то"                         │
│  □ Минимум >30% за месяц → предложить пересмотреть Норму           │
│                                                                     │
│  3.3 Проверка реальности (перки)                                    │
│  ───────────────────────────────                                    │
│  □ Все >7/10 две недели → "Не завышаешь ли?"                       │
│  □ Все <4/10 две недели → "Может, критерии слишком жёсткие?"       │
│                                                                     │
│  3.4 Напоминание о попытках                                         │
│  ──────────────────────────                                         │
│  □ 4-й день без попыток → мягкое напоминание                       │
│  □ Тон: "Всё ОК? Или забыл отметить?"                              │
│  □ Можно отключить в настройках                                     │
│                                                                     │
│  КРИТЕРИЙ ГОТОВНОСТИ:                                               │
│  ✓ Детектор распознаёт паттерны самокопания                        │
│  ✓ Сигналы появляются в нужный момент                              │
│  ✓ Тон сообщений — поддерживающий, не осуждающий                   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### Паттерны для детектора

```javascript
const SELF_JUDGMENT_PATTERNS = [
  /я\s+(плохой|плохая|слабак|неудачник|лузер|тупой|тупая)/i,
  /я\s+не\s+(могу|справлюсь|смогу)/i,
  /никогда\s+не\s+(смогу|получится|выйдет)/i,
  /всегда\s+(проваливаюсь|облажался|облажалась)/i,
  /я\s+должен|должна\s+был/i,  // много "должен"
  /бесполезн(ый|ая|о)/i,
  /ненавижу\s+себя/i
];

function detectSelfJudgment(text) {
  const matches = SELF_JUDGMENT_PATTERNS.filter(p => p.test(text));
  return matches.length >= 1;
}
```

---

## ФАЗА 4: Polish (Полировка)

**Цель:** Долгосрочный прогресс + архив + экспорт.

### Задачи

```
┌─────────────────────────────────────────────────────────────────────┐
│  ФАЗА 4 :: POLISH                                    [PRIORITY: P3] │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  4.1 Архив и графики                                                │
│  ───────────────────                                                │
│  □ UI: Секция "Архив" (новая)                                      │
│  □ График режимов за 30/90 дней                                    │
│  □ График эволюции перков (line chart)                             │
│  □ График священной коровы (bar chart по неделям)                  │
│                                                                     │
│  4.2 Архитектура окружения                                          │
│  ──────────────────────────                                         │
│  □ UI: Секция или модалка для записи изменений                     │
│  □ Напоминание в конце месяца                                      │
│  □ История изменений + результаты                                  │
│                                                                     │
│  4.3 Экспорт/Импорт                                                 │
│  ─────────────────                                                  │
│  □ Экспорт всех данных в JSON                                      │
│  □ Импорт с валидацией                                             │
│  □ Экспорт отчёта за месяц (markdown/PDF)                          │
│                                                                     │
│  4.4 Настройки                                                      │
│  ────────────                                                       │
│  □ Настройка священной коровы (минимум 3, цель 5 — редактируемо)   │
│  □ Включить/выключить напоминания                                  │
│  □ День недельного чека (по умолчанию воскресенье)                 │
│  □ Режим: показывать/скрывать старую систему                       │
│                                                                     │
│  КРИТЕРИЙ ГОТОВНОСТИ:                                               │
│  ✓ Видны графики за 3+ месяцев                                     │
│  ✓ Можно экспортировать/импортировать данные                       │
│  ✓ Система полностью настраиваемая                                 │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Зависимости между фазами

```
┌─────────────────────────────────────────────────────────────────────┐
│                                                                     │
│  ФАЗА 0 ──────┬──────► ФАЗА 1 ──────┬──────► ФАЗА 2                │
│  Foundation   │        Core Loop    │        Perks 2.0             │
│               │                     │                               │
│               │                     └──────► ФАЗА 3                │
│               │                              Intelligence           │
│               │                                    │                │
│               └────────────────────────────────────┴──► ФАЗА 4     │
│                                                         Polish      │
│                                                                     │
│  ЛЕГЕНДА:                                                           │
│  ────────► жёсткая зависимость (нельзя начать без предыдущей)      │
│  - - - -► мягкая зависимость (можно частично параллельно)          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

**Минимальный жизнеспособный продукт (MVP):** Фаза 0 + Фаза 1

После MVP можно итеративно добавлять Фазы 2-4.

---

## Оценка сложности

| Фаза | Новые файлы | Изменения в существующих | UI-экранов | Сложность |
|------|-------------|--------------------------|------------|-----------|
| 0 | 2 (game-state.js, migration.js) | storage.js, app.js, index.html | 1 модалка | ★★☆☆☆ |
| 1 | 1 (sacred-cow.js) | app.js, index.html, dashboard | 2 виджета | ★★★☆☆ |
| 2 | 2 (perks-v3.js, weekly-check.js) | index.html, перки | 3 экрана | ★★★★☆ |
| 3 | 1 (intelligence.js) | weekly-check.js, ui.js | 3 модалки | ★★★☆☆ |
| 4 | 1 (archive.js) | index.html, storage.js | 2 экрана | ★★★★☆ |

---

## Риски и митигация

```
┌─────────────────────────────────────────────────────────────────────┐
│  РИСКИ                                                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ⚠️ Потеря данных при миграции                                      │
│     → Бэкап перед миграцией (автоматический)                       │
│     → Возможность откатиться к v2                                  │
│                                                                     │
│  ⚠️ Пользователь не понимает новую систему                          │
│     → Онбординг при первом запуске v3                              │
│     → Возможность использовать "классический режим"                │
│                                                                     │
│  ⚠️ Система слишком сложная                                         │
│     → MVP = только режимы + священная корова                       │
│     → Остальное — опционально                                      │
│                                                                     │
│  ⚠️ Детектор самосуда даёт false positives                          │
│     → Порог: 2+ паттерна для срабатывания                          │
│     → Кнопка "Это не самосуд, продолжить"                          │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Совместимость с текущей системой

**Что сохраняем:**
- Трекинг тренировок, медитаций, кодинга (как источник данных для перков)
- Цели и прогресс
- Вес и PHQ-15
- Кодекс

**Что заменяем:**
- Старая система STR/PER/INT/WIL → новые S.P.E.C.I.A.L.
- Старые перки (unlock by level) → новые перки (manual assessment)
- XP-прогрессия → недельная рефлексия

**Переходный период:**
- Показывать обе системы (старая read-only, новая активная)
- Через 1-2 месяца — убрать старую по желанию

---

## Итого: Рекомендуемый порядок

```
╔═══════════════════════════════════════════════════════════════════╗
║  РЕКОМЕНДАЦИЯ                                                     ║
╠═══════════════════════════════════════════════════════════════════╣
║                                                                   ║
║  1. Начать с Фазы 0 + 1 (MVP)                                     ║
║     → Режимы + Священная корова                                   ║
║     → Можно использовать сразу                                    ║
║                                                                   ║
║  2. Потестировать 2-4 недели                                      ║
║     → Собрать feedback                                            ║
║     → Понять что работает, что нет                                ║
║                                                                   ║
║  3. Фаза 2 (Перки + Чеки)                                         ║
║     → Ядро новой рефлексивной системы                             ║
║                                                                   ║
║  4. Фаза 3-4 по мере необходимости                                ║
║     → Не обязательно сразу                                        ║
║     → Добавлять когда базовая система стабильна                   ║
║                                                                   ║
╚═══════════════════════════════════════════════════════════════════╝
```

```
═══════════════════════════════════════════════════════════════════════════════
                          [END OF ROADMAP]
                     VAULT-TEC DEVELOPMENT DIVISION
                         « BUILD FOR TOMORROW »
═══════════════════════════════════════════════════════════════════════════════
```
